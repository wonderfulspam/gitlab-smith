# Simplified and purposeful template hierarchy
.base_alpine:
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl

.node_setup:
  image: node:18
  before_script:
    - node --version
    - npm --version
    - npm ci --cache .npm --prefer-offline
  cache:
    key: "$CI_COMMIT_REF_SLUG-npm"
    paths:
      - node_modules/
      - .npm/

.node_build:
  extends: .node_setup
  stage: build

.node_test:
  extends: .node_setup
  stage: test

.node_integration_test:
  extends: .node_test
  services:
    - postgres:13
    - redis:6
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    DATABASE_URL: "postgresql://testuser:testpass@postgres:5432/testdb"
    REDIS_URL: "redis://redis:6379"

.docker_template:
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info

.docker_deploy:
  extends: .docker_template
  stage: deploy
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

.kubernetes_deploy:
  extends: .docker_deploy
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY
    - apk add --no-cache curl kubectl
  script:
    - kubectl config use-context $ENVIRONMENT
    - kubectl set image deployment/app app=$DOCKER_REGISTRY/app:$CI_COMMIT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/app -n $NAMESPACE
  environment:
    name: $ENVIRONMENT
    url: $URL