# Shared templates for all services
.node_setup:
  image: node:18
  before_script:
    - npm ci --cache .npm --prefer-offline
  cache:
    key: "$CI_COMMIT_REF_SLUG-npm"
    paths:
      - node_modules/
      - .npm/

.python_setup:
  image: python:3.11
  before_script:
    - pip install --cache-dir .pip -r requirements.txt
  cache:
    key: "$CI_COMMIT_REF_SLUG-pip"
    paths:
      - .pip/
      - .venv/

.go_setup:
  image: golang:1.20
  before_script:
    - go mod download
  cache:
    key: "$CI_COMMIT_REF_SLUG-go"
    paths:
      - /go/pkg/mod/

.docker_setup:
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

.service_build_template:
  stage: build
  artifacts:
    expire_in: 1 hour

.service_test_template:
  stage: test
  artifacts:
    when: always

.service_security_template:
  stage: security

.service_package_template:
  extends: .docker_setup
  stage: package