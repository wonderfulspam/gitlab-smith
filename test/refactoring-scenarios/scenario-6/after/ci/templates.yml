# Shared templates for all services
.node_setup:
  image: node:18
  before_script:
    - npm ci --cache .npm --prefer-offline
  cache:
    key: "$CI_COMMIT_REF_SLUG-npm"
    paths:
      - node_modules/
      - .npm/

.python_setup:
  image: python:3.11
  before_script:
    - pip install --cache-dir .pip -r requirements.txt
  cache:
    key: "$CI_COMMIT_REF_SLUG-pip"
    paths:
      - .pip/
      - .venv/

.go_setup:
  image: golang:1.20
  before_script:
    - go mod download
  cache:
    key: "$CI_COMMIT_REF_SLUG-go"
    paths:
      - /go/pkg/mod/

.docker_setup:
  image: docker:24.0  # Use latest stable version
  services:
    - docker:24.0-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_BUILDKIT: "1"  # Enable BuildKit for faster builds
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

.service_build_template:
  stage: build
  artifacts:
    expire_in: 1 hour

.service_test_template:
  stage: test
  artifacts:
    when: always

.service_security_template:
  stage: security

.service_package_template:
  extends: .docker_setup
  stage: package
  script:
    - docker build -f ${SERVICE_DIR}/Dockerfile -t $DOCKER_REGISTRY/${SERVICE_NAME}:$CI_COMMIT_SHA ${SERVICE_DIR}/
    - docker push $DOCKER_REGISTRY/${SERVICE_NAME}:$CI_COMMIT_SHA
  dependencies:
    - build:${SERVICE_NAME}
  rules:
    - changes:
        - "${SERVICE_DIR}/**/*"

# Common deployment template
.kubectl_deploy:
  image: bitnami/kubectl:1.28  # Use specific version
  stage: deploy
  before_script:
    - echo "Deploying ${SERVICE_NAME} to ${ENVIRONMENT}"
  script:
    - kubectl set image deployment/${SERVICE_NAME} ${SERVICE_NAME}=$DOCKER_REGISTRY/${SERVICE_NAME}:$CI_COMMIT_SHA -n ${ENVIRONMENT}
    - kubectl rollout status deployment/${SERVICE_NAME} -n ${ENVIRONMENT}