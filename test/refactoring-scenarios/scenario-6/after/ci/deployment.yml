# Deployment configuration using matrix
.deployment_base:
  extends: .kubectl_deploy
  parallel:
    matrix:
      - SERVICE_NAME: ["frontend", "api", "worker", "gateway"]
  dependencies:
    - package:${SERVICE_NAME}

deploy:staging:
  extends: .deployment_base
  variables:
    ENVIRONMENT: staging
  environment:
    name: staging
    url: https://staging.company.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy:production:
  extends: .deployment_base
  variables:
    ENVIRONMENT: production
  environment:
    name: production
    url: https://app.company.com
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: manual