# AFTER: Let GitLab auto-infer dependencies from artifacts
stages:
  - build
  - test
  - package

.node_base:
  image: node:22.7.0
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline

build:frontend:
  extends: .node_base
  stage: build
  script:
    - npm run build:frontend
  artifacts:
    paths:
      - dist/frontend/
    expire_in: 1 hour

build:backend:
  extends: .node_base
  stage: build
  script:
    - npm run build:backend
  artifacts:
    paths:
      - dist/backend/
    expire_in: 1 hour

test:integration:
  extends: .node_base
  stage: test
  script:
    - npm run test:integration

.docker_base:
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  cache:
    key: "docker-$CI_COMMIT_REF_SLUG"
    paths:
      - /var/lib/docker/
  before_script:
    - docker info

package:
  extends: .docker_base
  stage: package
  script:
    - docker build -t myapp:$CI_COMMIT_SHA .
    - docker push myapp:$CI_COMMIT_SHA