# AFTER: Docker setup consolidated using hidden job template
stages:
  - build
  - deploy

variables:
  DOCKER_REGISTRY: "registry.company.com"
  APP_NAME: "myapp"

.docker_base:
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

build:image:
  extends: .docker_base
  stage: build
  script:
    - docker build -t $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA .
    - docker push $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA

deploy:staging:
  extends: .docker_base
  stage: deploy
  script:
    - docker pull $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA
    - docker run -d $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA

deploy:production:
  extends: .docker_base
  stage: deploy
  script:
    - docker pull $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA
    - docker run -d $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA
  when: manual